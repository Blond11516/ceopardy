{% extends "base.html" %}
{% block title %}Game Board{% endblock %}

{% block style %}
<style>
    
</style>
{% endblock %}

{% block content %}
<div class="container-host">

    <div class="container-header container-slider flex-border-header container-light {{ 'slide-down' if not started }}">

        <div style="display: flex; width: 100%;">
            <div class="container-header-control container-padding">
                <p class="form-header form-color">Teams</p>
                <form id="form_teams">
                    {{ form.csrf_token }}
                    {# Dynamically render proper amount of fields based on 'teamname' flag in fields #}
                    {% for field in form if field.flags.teamname %}
                    <div class="form-row form-color team-info">
                        <div class="form-text">{{ field.label }}</div>
                        {{ field(class_="form-expand form-cursive form-text form-color form-no-form team-name", autocomplete="off", placeholder="Enter the name of the team") }}
                        {% if field.errors %}
                            {# FIXME layout issues here #}
                            <div class="alert alert-danger" role="alert">
                                {% for error in field.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                       <div class="form-icon form-click team-delete"><i class="fa fa-remove fa-lg"></i></div>
                    </div>
                    {% endfor %}
               <!--</div>-->
                <div id="form_teams_errors" class="form-row form-color">
                </div>
                <div class="form-expand"></div>
                <div class="form-row form-color">
                    <div class="form-expand"></div>
                    <div class="form-icon form-click team-add"><i class="fa fa-plus fa-lg"></i></div>
                    <div class="form-icon form-click team-refresh"><i class="fa fa-refresh fa-lg"></i></div>
                    <input type="submit" style="display: none">
                    <div class="form-expand"></div>
                </div>
                </form>
            </div>
        </div>
        
        <div class="container-arrow container-dark">
            <!--Down Arrow-->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 50" preserveAspectRatio="none">
                <polygon points="0,0 50,50 100,0 50,25 0,0"/>
            </svg>
        </div>

    </div>

    <!--For now...this is a place holder for the space occupied by the arrow-->
    <div class="container-all container-light" style="height: 35px;"></div>
    
    <div class="container-top container-all container-light">
        {% for _r in range(1, QUESTIONS_PER_CATEGORY + 1) %}
        <div class="row-ceopardy flex-vertical-pad" style="height: {{ height }}%;">
            {% for _c in range(1, CATEGORIES_PER_GAME + 1) %}
            <div class="col-ceopardy flex-horizontal-pad">
                <div id="c{{ _c }}q{{ _r }}" class="box-ceopardy box-question" role="button"><p>${{ _r * 100 }}</p></div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        <button id="roulette" type="button">Roulette!</button>
    </div>
    
    <div class="container-bottom container-all container-light">
        
    </div>
    
    <!--For now...this is a place holder for the space occupied by the arrow-->
    <div class="container-all container-light" style="height: 35px;"></div>
    
    <div class="container-footer container-slider flex-border-footer container-light {{ 'slide-up' if not started }}">
    
        <div class="container-arrow container-dark">
            <!--Up Arrow-->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 50" preserveAspectRatio="none">
                <polygon points="0,50 50,0 100,50 50,25 0,50"/>
            </svg>
        </div>
        
        <div style="display: flex; width: 100%;">
            <div class="container-footer-control container-padding">
                {% set one = {"title": "Game not started" } %}
                <p class="form-header form-color">Messages</p>
                {% for _m in MESSAGES %}
                <div id="messages">
                    <div class="form-row form-color team-info">
                        <div class="form-text">{{ _m.title }}</div>
                        <div class="form-hidden message-text">{{ _m.text }}</div>
                        <div class="form-expand"></div>
                        <div class="form-icon form-click message-display">
                            <i class="fa fa-eye fa-lg message-show"></i>
                            <i class="fa fa-eye-slash fa-lg message-hide" style="display: none;"></i>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div id="messages">
                    <div class="form-row form-color team-info">
                        <div class="form-text">Custom</div>
                        <div class="form-expand"></div>
                        <div class="form-icon form-click message-edit"><i class="fa fa-edit fa-lg"></i></div>
                        <div class="form-icon form-click message-display">
                            <i class="fa fa-eye fa-lg message-show"></i>
                            <i class="fa fa-eye-slash fa-lg message-hide" style="display: none;"></i>
                        </div>
                    </div>
                </div>
                <div class="form-expand">
                    <div id="message-custom" class="form-color form-edit" style="display: none;" contenteditable="true">
                        <span>test</span>
                    </div>
                </div>
                
            </div>
            <div class="container-separator-v container-dark"></div>
            <div class="container-footer-control">
                <iframe class="iframe-viewer" src="/viewer"></iframe>
            </div>
        </div>

    </div>

</div>
{% endblock %}

{% block ui %}
    <script>
        
        var socket = io.connect('http://' + document.domain + ':' + location.port + '/host');
        
        socket.on('connect', function() {
            //socket.emit('my event', {data: 'I\'m connected!'});
        });
        
        socket.on('test', function(data) {
            alert(data);
        });
        
        function ShowContainer(event) {
            var container = '.container-' + event.data.name;
            var slide = 'slide-' + event.data.direction
            if($(container).hasClass(slide)) {
                $(container).removeClass(slide); 
            }
            else {
                $(container).addClass(slide);
            }
        }
        
        function AddTeam(event) {
            {% if not VARIABLE_TEAMS %}
            alert("Fixed teams...");
            return;
            {% endif %}
            // This is not used right now!
            var info = $('#form_teams').find('.team-info');
            var count = info.length;
            if (count >= 5) {
                // Maximum number of teams...
                return;
            }
            count += 1;
            clone = info.first().clone();
            clone.find('.team-name').text("Team #" + count.toString());
            clone.find('.team-delete').click(DeleteTeam);
            $('#form_teams').append(clone);
        }
        
        function DeleteTeam(event) {
            {% if not VARIABLE_TEAMS %}
            alert("Fixed teams...");
            return;
            {% endif %}
            // This is not used right now!
            var info = $('#form_teams').find('.team-info');
            var count = info.length;
            if (count <= 1) {
                // Minimum number of teams...
                return;
            }
            $(this).closest('.team-info').remove();
        }
        
        function RefreshTeams(event) {
            var url = "{{ url_for('setup') }}";
            $.ajax({
                type: "POST",
                url: url,
                data: $('#form_teams').serialize(),
                dataType: 'json',
                success: function (data) {
                    if (data.result == "success") {
                        $('.container-header').removeClass('slide-down');
                    }
                    else {
                        // TODO improve error handling
                        if (data.errors) {
                            var errors = "";
                            $.each(data.errors, function (k, v) {
                                errors += v + "<br/>";
                            });
                            $("div#form_teams_errors").html('<span class="error">' + errors + '</span>');
                        }
                    }
                }
            });
        }

        function DisplayMessage(event) {
            var show = $(this).find('.message-show');
            var hide = $(this).find('.message-hide');
            var visible = show.is(":visible");
            $('.message-hide').hide();
            $('.message-show').show();
            var element = $(this).parent().find('.message-text');
            if (visible) {
                show.hide();
                hide.show();
                ShowMessage(element);
            }
            else {
                hide.hide();
                show.show();
                HideMessage();
            }
        }
        
        function ShowMessage(element) {
            if (element.length == 0) {
                text = $('#message-custom').first().text();
            }
            else {
                text = element.text();
            }
            socket.emit('message', {action: "show", text: text});
        }
        
        function HideMessage() {
            socket.emit('message', {action: "hide"});
        }
        
        function EditMessage(event) {
            if ($('#message-custom').is(":visible")) {
                $('#message-custom').children().hide();
                $('#message-custom').animate({"height": "0"}, 600, function() {
                    $('#message-custom').hide();
                });
            }
            else {
                $('#message-custom').show();
                $('#message-custom').animate({"height": "100%"}, 600, function() {
                    $('#message-custom').children().show();
                });
            }
        }
        
        $(document).ready(function() {

            $(".box-ceopardy").on("click", function() {
                var id = $(this).attr('id');
                if ($(this).hasClass("box-selected")) {
                    $(this).removeClass("box-selected");
                    $(this).addClass("box-completed");
                    socket.emit('unclick', {id: id});
                }
                else {
                    $(".box-selected").addClass("box-completed");
                    $(".box-selected").removeClass("box-selected");
                    $(this).removeClass("box-completed");
                    $(this).addClass("box-selected");
                    socket.emit('click', {id: id});
                }
            });
            
            $("#roulette").on("click", function() {
                socket.emit('roulette');
                /*$.post("/api/roulette", function(data) {
                    if (data.result != "ok") {
                        alert(data.result);
                    }
                    else {
                        
                    }
                });*/
            });
            
            {# if not started #}
            $('.container-header > .container-arrow').on("click", 
                {'name': 'header', 'direction': 'down'}, ShowContainer);
            {# endif #}
            $('.container-footer > .container-arrow').on("click", 
                {'name': 'footer', 'direction': 'up'}, ShowContainer);
            
            $('.team-add').on("click", AddTeam);
            $('.team-delete').on("click", DeleteTeam);
            $('.team-refresh').on("click", RefreshTeams);
            $('#form_teams').submit(function(e){
                e.preventDefault();
                RefreshTeams(e);
            });

            
            $('.message-display').on("click", DisplayMessage);
            $('.message-edit').on("click", EditMessage);
            
            {% if not started %}
            // First message should be the one about starting the game
            // This might not be the best solution, we'll see...
            $('#messages').find('.message-display').first().trigger('click');
            {% endif %}

            // Inject CSRF token
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
                    }
                }
            });
        });
        
    </script>
{% endblock %}
